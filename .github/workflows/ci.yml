# .github/workflows/ci.yml
name: CI - Quality Check & Testing

on:
  push:
    branches: [main, develop]

jobs:
  # Paso 1: Quality Check
  quality-check:
    name: 'Quality Check'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: ESLint Check
        run: npm run lint

      - name: Type Check (if using TypeScript)
        run: npm run type-check || echo "Type check skipped"

      - name: Vue.js components validation
        run: npm run validate || echo "Validation skipped"

  # Paso 2: Testing
  test:
    name: 'Testing'
    runs-on: ubuntu-latest
    needs: quality-check

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: laravel_test
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, dom, fileinfo, mysql, gd
          coverage: xdebug

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install PHP dependencies
        run: composer install

      - name: Install Node dependencies
        run: npm ci

      - name: Create test environment
        run: |
          cp .env.example .env
          php artisan key:generate

      - name: Configure test database
        run: |
          php artisan config:cache
          php artisan migrate --force
        env:
          DB_CONNECTION: mysql
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_DATABASE: laravel_test
          DB_USERNAME: root
          DB_PASSWORD: password

      # - name: Run PHP tests
      #   run: |
      #     php artisan config:clear
      #     php artisan test --parallel
      #   env:
      #     DB_CONNECTION: mysql
      #     DB_HOST: 127.0.0.1
      #     DB_PORT: 3306
      #     DB_DATABASE: laravel_test
      #     DB_USERNAME: root
      #     DB_PASSWORD: password

      # - name: Run JavaScript tests
      #   run: npm run test || echo "JS tests skipped"

  # Paso 3: Build (solo para validar que compila)
  build:
    name: 'Build Validation'
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build assets (validation only)
        run: npm run build
